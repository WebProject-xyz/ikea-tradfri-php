on: [ push, pull_request ]
name: Codecov

jobs:
    codeception-tests-coverage:
        name: "Codecov and Codacy coverage run"
        runs-on: "ubuntu-latest"
        continue-on-error: ${{ matrix.allow-fail }}
        strategy:
            matrix:
                include:
                    - { php-version: 8.3, dependencies: locked, coverage: xdebug, with_coverage: true, allow-fail: false }

        steps:
            -   name: "Checkout"
                uses: "actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd" # v5.0.1

            -   name: "Install PHP"
                uses: "shivammathur/setup-php@7bf05c6b704e0b9bfee22300130a31b5ea68d593" # v2
                with:
                    coverage: "${{ matrix.coverage }}"
                    ini-values: display_errors=On, display_startup_errors=On, error_reporting=32767
                    php-version: "${{ matrix.php-version }}"

            -   name: "Set up problem matchers for PHP"
                run: "echo \"::add-matcher::${{ runner.tool_cache }}/php.json\""

            -   name: "Set up problem matchers for phpunit/phpunit"
                run: "echo \"::add-matcher::${{ runner.tool_cache }}/phpunit.json\""

            -   name: "Validate composer.json and composer.lock"
                run: "composer validate --ansi --strict"

            -   name: "Determine composer cache directory"
                uses: "ergebnis/.github/actions/composer/determine-cache-directory@4103ff7c010d2c18dc84f72d6704227868412482" # 1.10.0

            -   name: "Cache dependencies installed with composer"
                uses: "actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830" # v4.3.0
                with:
                    path: "${{ env.COMPOSER_CACHE_DIR }}"
                    key: "php-${{ matrix.php-version }}-composer-${{ matrix.dependencies }}-${{ hashFiles('composer.lock') }}"
                    restore-keys: "php-${{ matrix.php-version }}-composer-${{ matrix.dependencies }}-"

            -   name: "Install ${{ matrix.dependencies }} dependencies with composer"
                uses: "ergebnis/.github/actions/composer/install@4103ff7c010d2c18dc84f72d6704227868412482" # 1.10.0
                with:
                    dependencies: "${{ matrix.dependencies }}"

            -   name: "Run Codeception with coverage"
                run: |
                    vendor/bin/codecept run -c . -vvv --coverage --coverage-xml=clover.xml --xml
                    
            -   name: "Upload Coverage coverage"
                run: |
                    export CODACY_PROJECT_TOKEN=${{ secrets.CODACY_PROJECT_TOKEN }}
                    bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r ./build/logs/clover.xml

            -   name: Upload test results to Codecov
                if: ${{ !cancelled() }}
                uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # v1
                with:
                    files: ./build/logs/report.xml
                    token: ${{ secrets.CODECOV_TOKEN }}

            -   name: Upload coverage to Codecov
                uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5
                with:
                    token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
                    files: ./build/logs/clover.xml
                    flags: unittests # optional
                    fail_ci_if_error: "${{ matrix.with_coverage }}" # optional (default = false)
                    verbose: false # optional (default = false)
